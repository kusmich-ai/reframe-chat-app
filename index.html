<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Reframe Protocol</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function ClaudeChatInterface() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const sendMessage = async () => {
        if (!input.trim() || isLoading) return;

        const userMessage = input.trim();
        setInput('');
        setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
        setIsLoading(true);

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              messages: [...messages, { role: 'user', content: userMessage }].filter(m => m.role === 'user' || m.role === 'assistant'),
            }),
          });

          if (!response.ok) {
            throw new Error('API request failed');
          }

          const data = await response.json();
          const assistantMessage = data.content
            .filter(block => block.type === 'text')
            .map(block => block.text)
            .join('\n');

          setMessages(prev => [...prev, { role: 'assistant', content: assistantMessage }]);
        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => [
            ...prev,
            { role: 'assistant', content: 'Sorry, there was an error processing your request.' },
          ]);
        } finally {
          setIsLoading(false);
          inputRef.current?.focus();
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      return (
        <div className="h-screen w-full bg-black flex flex-col">
          {/* Fixed Header with Logo */}
          <div className="border-b border-zinc-800 p-6">
            <div className="max-w-2xl mx-auto">
              <img src="/logo.png" alt="Logo" className="h-8" />
            </div>
          </div>

          {/* Scrollable Content Area */}
          <div className="flex-1 overflow-y-auto px-6">
            <div className="max-w-2xl mx-auto">
              {/* Title and Description - Scrolls with content */}
              <div className="py-12 text-center">
                <h1 className="text-3xl font-bold text-amber-500 mb-4">The Reframe Protocol</h1>
                <p className="text-zinc-400 font-light leading-relaxed">To identify and update distorted or limiting mental models in real time by interrogating the story the mind is telling about an event and consciously replacing it with an interpretation that restores agency, calm, and clarity.</p>
              </div>

              {messages.length === 0 ? (
                <div className="py-12 text-center">
                  <p className="text-zinc-600 text-lg font-light">What just happened? Or What am I reacting to?</p>
                </div>
              ) : (
                <div className="space-y-8 pb-8">
                  {messages.map((message, index) => (
                    <div key={index} className="group">
                      <div className={`text-sm font-medium mb-2 ${message.role === 'user' ? 'text-zinc-500 text-right' : 'text-amber-500'}`}>
                        {message.role === 'user' ? 'You' : 'The Reframe Protocol'}
                      </div>
                      <div className={`${message.role === 'user' ? 'text-zinc-500 text-right' : 'text-zinc-200'} font-light leading-relaxed whitespace-pre-wrap`}>
                        {message.content}
                      </div>
                    </div>
                  ))}
                  {isLoading && (
                    <div className="group">
                      <div className="text-sm font-medium mb-2 text-amber-500">The Reframe Protocol</div>
                      <div className="flex items-center gap-1 text-amber-500">
                        <span className="inline-block w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                        <span className="inline-block w-2 h-2 bg-amber-500 rounded-full animate-pulse" style={{animationDelay: '0.2s'}}></span>
                        <span className="inline-block w-2 h-2 bg-amber-500 rounded-full animate-pulse" style={{animationDelay: '0.4s'}}></span>
                      </div>
                    </div>
                  )}
                  <div ref={messagesEndRef} />
                </div>
              )}
            </div>
          </div>

          {/* Fixed Input Area */}
          <div className="border-t border-zinc-800 p-6">
            <div className="max-w-2xl mx-auto">
              <div className="flex gap-3 items-end">
                <div className="flex-1 bg-zinc-950 border border-zinc-800 rounded-lg focus-within:border-amber-500 transition-colors">
                  <textarea
                    ref={inputRef}
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyPress={handleKeyPress}
                    placeholder="Type your message..."
                    disabled={isLoading}
                    className="w-full bg-transparent text-zinc-300 placeholder-zinc-600 px-4 py-3 resize-none focus:outline-none font-light"
                    rows="3"
                  />
                </div>
                <button
                  onClick={sendMessage}
                  disabled={!input.trim() || isLoading}
                  className="bg-amber-500 hover:bg-amber-600 disabled:bg-zinc-800 disabled:cursor-not-allowed text-black p-4 rounded-lg transition-colors flex items-center justify-center"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<ClaudeChatInterface />, document.getElementById('root'));
  </script>
</body>
</html>
